// Generate a forms.csv for import into SRL drupal
// The source json files were all generated by scraping the courts.ca.gov form search and self-help pages

let _ = require('underscore');
let fs = require('fs');
let parseCsv = require('csv-parse/lib/sync');

let forms = JSON.parse(fs.readFileSync('./data/forms.json'));
let guides = JSON.parse(fs.readFileSync('./data/guides.self-help-forms-pages.json'));
let formsByGuide = JSON.parse(fs.readFileSync('./data/forms-by-guide.self-help-forms-pages.json'));
let languageVariantsByFormId = JSON.parse(fs.readFileSync('./data/language-variants-by-form-id.json'));
let languageLetters = JSON.parse(fs.readFileSync('./data/language-letters.json'));
let allLanguages = Array.from(new Set(languageLetters.map(r => r.language))).sort();
let formDescriptions = parseFormDescriptionsCsv('./data/Family Law Forms 1.csv');

function tagForms() {
  forms.forEach(form => {
    let categories = formsByGuide.filter(category => category.formUrls.includes(form.url));
    form.caseTypes = categories.map((category) => guides.find(g => g.id === category.guideId).title);
  });
}

function parseFormDescriptionsCsv(filename) {
  let rawText = fs.readFileSync(filename).toString();
  let rows = parseCsv(rawText, { columns: true });
  let removeAsteriskRegex = /\*/g;
  // Add an id to each row that matches the id in forms.json (no asterisk)
  rows.forEach(r => r.id = r['Form Number'].replace(removeAsteriskRegex, ''));
  return rows;
}

function getFormDescription(formId) {
  let formDescriptionRow = formDescriptions.find(r => r.id === formId);
  return formDescriptionRow ? formDescriptionRow['Plain language description (1-2 sentences)'] : '';
}

function getLanguageUrl(formId, language) {
  let languageVariants = languageVariantsByFormId[formId];
  if (!languageVariants)
    return '';

  let matchingVariant = languageVariants.find(r => r.language === language);
  return matchingVariant ? matchingVariant.form.url : '';
}

// If a form has a language letter at the end of its number,
// it is not a canonical form--it is a language guide.
function isCanonicalForm(form) {
  let languageLetterRegex = /^(.+)\s([A-Z]+)$/
  return !languageLetterRegex.test(form.id);
}

function saveFormsCsv() {
  tagForms();
  let columns = [
    'Form name',
    'Form number',
    'Case types',
    'Plain language description (1-2 sentences)',
    'PDF URL'
  ].concat(allLanguages.map(language => `${language} URL`));

  let nonCanonicalForms = forms.filter(f => !isCanonicalForm(f));
  console.log(`${nonCanonicalForms.map(f => f.id).join('\n')}`);
  console.log(`Skipped ${nonCanonicalForms.length} non-canonical forms listed above.`);

  console.log(`T tagalog forms ${nonCanonicalForms.filter(f => f.id.endsWith(' T')).map(f => f.url).join(', ')}`)
  console.log(`TG tagalog forms ${nonCanonicalForms.filter(f => f.id.endsWith(' TG')).map(f => f.url).join(', ')}`)

  console.log(`Language column order: ${allLanguages.join(', ')}`);
  
  let formRows = forms
    .filter(isCanonicalForm)
    .map((form) => {
      return [
        `"${form.title}"`,
        form.id,
        `"${form.caseTypes.join(', ')}"`,
        `"${getFormDescription(form.id)}"`,
        form.url
      ].concat(allLanguages.map(language => getLanguageUrl(form.id, language))).join(',');
    });
  let header = columns.join(',');
  let allRows = Array.prototype.concat(header, formRows);
  fs.writeFileSync('output/forms.csv', allRows.join('\n'));
}

function saveCaseTypesCsv() {
  let columns = [
    'Case Type',
    'Info Url',
    'Info Url Title'
  ];
  let caseTypeRows = guides.map((guide) => {
    return [
      `"${guide.title}"`,
      guide.url,
      `"How-to instructions for ${guide.title}"`
    ].join(',');
  });
  let header = columns.join(',');
  let allRows = Array.prototype.concat(header, caseTypeRows);
  fs.writeFileSync('output/case_types.csv', allRows.join('\n'));
}

function printFormsWithDuplicateNumbers() {
  let formsByTitle = _.groupBy(forms, f => f.title);
  let dupes =
    _.zip(Object.keys(formsByTitle), Object.values(formsByTitle))
      .filter(row => row[1].length > 1)
      .map(row => ({ title: row[0], ids: row[1].map(f => f.id )}));
  console.log(JSON.stringify(dupes, null, 2));
}

// saveFormsCsv();
saveCaseTypesCsv();
// printFormsWithDuplicateNumbers();